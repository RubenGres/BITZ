<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Species Quest</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container mt-4">
        <div id="page1">
            <h2>Choose Location üìç</h2>
            <label for="place_name" class="form-label">Enter place name or scroll on the map:</label>
            
            <input type="text" id="place_name" class="form-control" placeholder="e.g. Paris, France">
            <div class="mb-3">
                <button class="btn btn-primary" onclick="searchPlace()">Find Place</button>
            </div>
            
            <div id="map-container" style="position: relative;">
                <div id="map" style="height: 500px;"></div>
                <div id="map-cursor"></div>
                <div id="coordinates">Lat: - | Lon: -</div>
            </div>

            <div class="text-center mt-3">
                <button class="btn btn-success" onclick="goToPage(2)">Confirm Location</button>
            </div>
        </div>
        
        <!-- Rest of the previous HTML remains the same -->
        <div id="page2" style="display: none;">
            <h2>Here are species around you üïµÔ∏è‚Äç‚ôÄÔ∏è</h2>
            <div id="species-container" class="bubble-container mt-3"></div>
            <div class="text-center mt-3">
                <button class="btn btn-success" onclick="goToPage(3)">Start Quest</button>
            </div>
        </div>

        <div id="page3" style="display: none;">
            <h2>Species Quest üå±</h2>
            <div id="chat-box" class="border p-3 mb-3" style="height: 400px; overflow-y: auto;"></div>
            
            <!-- Spinner -->
            <div id="spinner" class="text-center" style="display: none;">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>

            <div class="input-group mb-2">
                <input type="text" id="user-input" class="form-control" placeholder="Type your message...">
                <button class="btn btn-success" onclick="sendMessage()">Send</button>
            </div>

            <div id="image-upload-container" class="mb-2">
                <input type="file" id="image-upload" accept="image/*" capture="environment" style="display:none;">
                <button class="btn btn-outline-secondary" onclick="document.getElementById('image-upload').click()">
                    üì∑ Take Photo
                </button>
                <img id="image-preview" src="" style="display:none;">
            </div>
            
        </div>

    </div>

    <script>
        backend_url = "https://scaling-space-carnival-qvvrrjxqgrp246pj-5000.app.github.dev"

        let map = L.map('map').setView([48.8566, 2.3522], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
        
        let marker;
        let selectedLat, selectedLon;
        const mapCursor = document.getElementById('map-cursor');
        const coordinatesDisplay = document.getElementById('coordinates');

        function getUserLocation() {
            return new Promise((resolve) => {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    () => resolve(null)
                );
            });
        }

        // Center cursor on map
        function updateMapCursor(e) {
            const mapContainer = document.getElementById('map-container');
            const mapRect = mapContainer.getBoundingClientRect();
            const centerX = mapRect.width / 2;
            const centerY = mapRect.height / 2;

            mapCursor.style.left = `${centerX}px`;
            mapCursor.style.top = `${centerY}px`;

            // Get map center coordinates
            const center = map.getCenter();
            selectedLat = center.lat.toFixed(4);
            selectedLon = center.lng.toFixed(4);
            
            coordinatesDisplay.innerHTML = `Lat: ${selectedLat} | Lon: ${selectedLon}`;
        }

        // Update cursor and coordinates when map moves
        map.on('move', updateMapCursor);
        
        // Initial cursor placement
        updateMapCursor();

        function searchPlace() {
            let place = document.getElementById("place_name").value;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${place}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        map.setView([data[0].lat, data[0].lon], 12);
                    } else {
                        alert("Location not found");
                    }
                });
        }
        
        // Rest of the previous script remains the same
        function goToPage(pageNumber) {
            document.getElementById("page1").style.display = pageNumber === 1 ? "block" : "none";
            document.getElementById("page2").style.display = pageNumber === 2 ? "block" : "none";
            document.getElementById("page3").style.display = pageNumber === 3 ? "block" : "none";
            
            if (pageNumber === 2) {
                fetchSpecies();
            }
        }

        function fetchSpecies() {
            const radius = 10; // 10 km radius, adjust as needed

            document.getElementById("species-container").innerHTML = "<p>Loading species...</p>";
            fetch(`https://api.inaturalist.org/v1/observations/species_counts?lat=${selectedLat}&lng=${selectedLon}&radius=${radius}&verifiable=true`)
                .then(response => response.json())
                .then(data => {
                    if (!data.results || data.results.length === 0) {
                        document.getElementById("species-container").innerHTML = "<p>No species found in this location.</p>";
                        return;
                    }

                    const maxCount = Math.max(...data.results.map(species => species.count));

                    let speciesData = data.results.slice(0, 10).map(species_info => {
                        let taxon = species_info.taxon || {};
                        let size = Math.max(50, Math.min(200, (species_info.count / maxCount) * 150));
                        return `
                            <div class='bubble' style='width: ${size}px; height: ${size}px;'>
                                <img src='${taxon.default_photo ? taxon.default_photo.medium_url : ''}'>
                                <span>
                                    <h3>${taxon.name || 'Unknown'}</h3>
                                    ${taxon.common_name || 'No common name'}
                                </span>
                            </div>
                        `;
                    }).join('');
                    document.getElementById("species-container").innerHTML = speciesData;
                })
                .catch(error => {
                    document.getElementById("species-container").innerHTML = "<p>Error fetching species.</p>";
                });
        }
        
        document.getElementById('image-upload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            
            if (file) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                }
                
                reader.readAsDataURL(file);
            }

            const imagePreview = document.getElementById('image-preview');
        });


        const conversation_id = Math.random().toString().slice(2, 12);
        async function sendMessage() {
            let input = document.getElementById("user-input");
            let chatBox = document.getElementById("chat-box");
            let userMessage = input.value.trim();
            let imagePreview = document.getElementById("image-preview");
            let imagePreview_src = document.getElementById("image-preview").src;
            let userLocation = "Amstelpark, Amsterdam";
            let spinner = document.getElementById("spinner");

            if (!userMessage && (!imagePreview_src || imagePreview_src === "")) {
                return; // Prevent sending empty messages
            }

            input.value = "";
            imagePreview.src = "";
            imagePreview.style.display = "none";
            document.getElementById("image-upload").value = "";
            chatBox.scrollTop = chatBox.scrollHeight;

            spinner.style.display = "block"; // Show spinner

            // Create message container
            let messageDiv = document.createElement("div");
            messageDiv.innerHTML += `<div><b>You:</b> ${userMessage}</div>`;
            chatBox.appendChild(messageDiv);
            
            let imageBase64 = "";
            if (imagePreview_src && imagePreview_src.startsWith("data:image")) {
                imageBase64 = imagePreview_src.split(",")[1];
                messageDiv.innerHTML += `<img src="${imagePreview_src}" style="max-width: 200px; max-height: 200px;"><br>`;
            }

            messageDiv.innerHTML += `<br>`

            try {
                let response = await fetch(`${backend_url}/chat`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    mode: "cors",
                    body: JSON.stringify({
                        message: userMessage,
                        history: getChatHistory(),
                        conversation_id: conversation_id,
                        user_location: userLocation,
                        image_b64: imageBase64
                    })
                });

                let data = await response.json();
                let botResponse = document.createElement("div");
                botResponse.innerHTML = `<div><b>OAAK:</b> ${data.response}</div><br>`;
                chatBox.appendChild(botResponse);
                chatBox.scrollTop = chatBox.scrollHeight;
            } catch (error) {
                console.error("Error sending message:", error);
            } finally {
                spinner.style.display = "none"; // Hide spinner after response
            }
        }


        function getChatHistory() {
            let messages = document.querySelectorAll("#chat-box div");
            let history = [];
            for (let i = 0; i < messages.length; i += 2) {
                let userMsg = messages[i]?.textContent.replace("You: ", "");
                let botMsg = messages[i + 1]?.textContent.replace("Bot: ", "");
                if (userMsg && botMsg) {
                    history.push([userMsg, botMsg]);
                }
            }
            return history;
        }

    </script>
</body>
</html>