<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Species Discovery Journey</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" rel="stylesheet">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 10px;
            background-color: #f5f5f5;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .back-button {
            grid-column: span 2;
            display: inline-block;
            margin-bottom: 15px;
            padding: 8px 15px;
            background-color: #f0f0f0;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: background-color 0.3s ease;
        }

        .back-button:hover {
            background-color: #e0e0e0;
        }

        #map {
            height: 500px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .conversation {
            max-height: 500px;
            overflow-y: auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 15px;
        }

        
        .message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }

        .user-message {
            background-color: #e6f2ff;
        }

        .assistant-message {
            background-color: #f0f0f0;
            text-align: left;
        }

        .message img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 5px;
            margin-top: 10px;
        }

        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .species-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            grid-column: span 2;
        }

        .species-table th, .species-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }

        .species-table img {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
        }

        .error-message {
            background-color: #ffebee;
            color: #d32f2f;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            grid-column: span 2;
        }

        @media (max-width: 768px) {
            body {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <a href="/explore/" class="back-button">← Back to Explorer</a>

    <div id="map"></div>
    <div class="conversation" id="conversation"></div>

    <div class="controls" style="grid-column: span 2;">
        <input type="text" id="search" placeholder="Search species..." oninput="filterTable()">
        <select id="groupFilter" onchange="filterTable()">
            <option value="">All Groups</option>
        </select>
    </div>

    <table class="species-table">
        <thead>
            <tr>
                <th>Image</th>
                <th>Taxonomic Group</th>
                <th>Scientific Name</th>
                <th>Common Name</th>
                <th>Discovery Timestamp</th>
            </tr>
        </thead>
        <tbody id="species-tbody"></tbody>
    </table>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        const historyPath = '{{ history_path }}';
        const csvPath = '{{ csv_path }}';
        const imagesBasePath = '{{ images_base_path }}';

        let historyData = [];
        let speciesData = [];

        // Initialize map
        const map = L.map('map').setView([0.0, 0.0], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // Fetch and process CSV data
        async function processCsvData(csv) {
            try {
                const lines = csv.split('\n');
                const headers = lines[0].split(',');

                speciesData = lines.slice(1).map(line => {
                    if (!line.trim()) return null;
                    
                    const values = line.split(',');
                    return {
                        image_name: values[0],
                        taxonomic_group: values[1],
                        scientific_name: values[2],
                        common_name: values[3]
                    };
                }).filter(row => row !== null && row.image_name);

                if (speciesData.length === 0) {
                    throw new Error('No species data found');
                }

                updateGroupFilter();
            } catch (error) {
                console.error('Error processing CSV:', error);
                showErrorMessage('No species data available. Please check the data source.');
            }
        }

        // Show error message on the page
        function showErrorMessage(message) {
            const errorDiv = document.createElement('div');
            errorDiv.classList.add('error-message');
            errorDiv.textContent = message;
            
            // Insert the error message before the species table
            const speciesTable = document.querySelector('.species-table');
            speciesTable.parentNode.insertBefore(errorDiv, speciesTable);
        }

        // Update group filter options
        function updateGroupFilter() {
            const groups = new Set(speciesData.map(row => row.taxonomic_group));
            const select = document.getElementById('groupFilter');
            select.innerHTML = '<option value="">All Groups</option>';

            groups.forEach(group => {
                if (group) {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    select.appendChild(option);
                }
            });
        }

        // Fetch and process history data
        async function loadData() {
            try {
                // Fetch history JSON
                const historyResponse = await fetch(historyPath);
                const historyJson = await historyResponse.json();
                historyData = historyJson.history;

                // Fetch CSV with extended error handling
                try {
                    const csvResponse = await fetch(csvPath);
                    if (csvResponse.ok) {
                        const csvText = await csvResponse.text();
                        await processCsvData(csvText);
                    } else {
                        throw new Error('CSV file not found or inaccessible');
                    }
                } catch(error) {
                    console.error('CSV fetch error:', error);
                    showErrorMessage('Unable to load species data. Please check the CSV file.');
                }

                // Populate conversation
                const conversationDiv = document.getElementById('conversation');
                historyData.forEach(entry => {
                    // Only create a message if there's user or assistant text
                    if ((entry.user && entry.user.trim() !== '') || entry.assistant) {
                        const messageEl = document.createElement('div');
                        messageEl.classList.add('message');
                        
                        // Determine message type and content
                        messageEl.classList.add('user-message');
                        messageEl.innerHTML = `<strong>User:</strong> </br> ${entry.user} </br> `;
                        
                        // Add image to user message if exists
                        if (entry.image_filename) {
                            const imgEl = document.createElement('img');
                            imgEl.src = `${imagesBasePath}${entry.image_filename}`;
                            imgEl.alt = 'Species image';
                            messageEl.appendChild(imgEl);
                        }
                        
                        if (entry.assistant) {
                            const assistantMessageEl = document.createElement('div');
                            assistantMessageEl.classList.add('message', 'assistant-message');
                            assistantMessageEl.innerHTML = `<strong>Assistant:</strong> </br> ${entry.assistant} </br> `;

                            // Add timestamp to both messages
                            const timestampEl = document.createElement('div');
                            timestampEl.innerHTML = `</br> <small>${new Date(entry.timestamp).toLocaleString()}</small>`;
                            messageEl.appendChild(timestampEl);
                            assistantMessageEl.appendChild(timestampEl.cloneNode(true));

                            // Add both messages
                            conversationDiv.appendChild(messageEl);
                            conversationDiv.appendChild(assistantMessageEl);
                        } else {
                            // Add timestamp for user-only messages
                            const timestampEl = document.createElement('div');
                            timestampEl.innerHTML = `</br> <small>${new Date(entry.timestamp).toLocaleString()}</small>`;
                            messageEl.appendChild(timestampEl);
                            conversationDiv.appendChild(messageEl);
                        }
                    }
                });

                // Populate species table
                // If speciesData is empty, this will not add anything
                populateSpeciesTable(historyData, speciesData);

                addCenterCursor(historyJson);
                populateMapCursors(historyData);

            } catch (error) {
                console.error('Error loading data:', error);
                showErrorMessage('Unable to load history data. Please check the data source.');
            }
        }

        function addCenterCursor(historyJson) {
            // Check if historyJson has the location property with coordinates
            if (historyJson && 
                historyJson.location && 
                historyJson.location.coordinates && 
                historyJson.location.coordinates.latitude && 
                historyJson.location.coordinates.longitude) {
                
                // Extract the coordinates
                const lat = historyJson.location.coordinates.latitude;
                const lng = historyJson.location.coordinates.longitude;
                
                // Create a custom red icon
                const redIcon = L.divIcon({
                    html: `<div style="background-color: #ff3333; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; border: 2px solid white;"></div>`,
                    className: 'center-marker',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });
                
                // Add the marker to the map with the red icon
                const centerMarker = L.marker([lat, lng], { icon: redIcon }).addTo(map);
                
                // Add a popup with location information
                centerMarker.bindPopup(`
                    <strong>Center Location</strong><br>
                    Latitude: ${lat}<br>
                    Longitude: ${lng}
                `);
                
                // Center the map on this location
                map.setView([lat, lng], 14);
                
                // Store the marker reference if needed for later manipulation
                window.centerMarker = centerMarker;
                
                console.log('Center cursor added at:', lat, lng);
            } else {
                console.error('Location coordinates not found in history JSON');
            }
        }


        function populateMapCursors(historyData) {
            // Clear any existing markers first
            map.eachLayer(layer => {
                if (layer instanceof L.Marker) {
                    map.removeLayer(layer);
                }
            });
            
            // Filter history entries that have image locations
            const entriesWithLocations = historyData.filter(entry => 
                entry.image_location && 
                entry.image_location.latitude && 
                entry.image_location.longitude
            );
            
            // Create markers for each location
            entriesWithLocations.forEach((entry, index) => {
                // Create a custom numbered icon
                const numberIcon = L.divIcon({
                    html: `<div style="background-color: #3388ff; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${index + 1}</div>`,
                    className: 'number-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                // Create the marker with the numbered icon
                const marker = L.marker(
                    [entry.image_location.latitude, entry.image_location.longitude],
                    { icon: numberIcon }
                ).addTo(map);
                
                // Prepare popup content
                let popupContent = '';
                
                // Add image if available
                if (entry.image_filename) {
                    popupContent += `<img src="${imagesBasePath}${entry.image_filename}" style="max-width:200px; max-height:150px;"><br>`;
                }
                
                // Look up species info if available
                const speciesInfo = speciesData.find(species => species.image_name === entry.image_filename);
                
                if (speciesInfo) {
                    popupContent += `<strong>${speciesInfo.common_name || speciesInfo.scientific_name}</strong><br>`;
                    popupContent += `<em>${speciesInfo.scientific_name}</em><br>`;
                    popupContent += `Group: ${speciesInfo.taxonomic_group}<br>`;
                }
                
                // Add timestamp
                popupContent += `<small>Discovered: ${new Date(entry.timestamp).toLocaleString()}</small>`;
                
                // Bind popup to marker
                marker.bindPopup(popupContent);
                
                // Show popup on hover
                marker.on('mouseover', function() {
                    this.openPopup();
                });
            });
            
            // Fit map to show all markers if there are any
            if (entriesWithLocations.length > 0) {
                const group = L.featureGroup(
                    entriesWithLocations.map(entry => 
                        L.marker([entry.image_location.latitude, entry.image_location.longitude])
                    )
                );
                map.fitBounds(group.getBounds().pad(0.2));
            }
        }

        // Populate species table with combined data
        function populateSpeciesTable(historyData, speciesData) {
            const speciesTbody = document.getElementById('species-tbody');
            speciesTbody.innerHTML = ''; // Clear existing rows

            // If no species data, display a message
            if (speciesData.length === 0) {
                const row = speciesTbody.insertRow();
                const noDataCell = row.insertCell(0);
                noDataCell.colSpan = 5;
                noDataCell.textContent = 'No species data available';
                noDataCell.style.textAlign = 'center';
                return;
            }

            // Create a map of image filenames to their timestamps from history
            const imageTimestamps = new Map(
                historyData
                    .filter(entry => entry.image_filename)
                    .map(entry => [entry.image_filename, entry.timestamp])
            );

            speciesData.forEach(species => {
                // Find corresponding history entry
                const row = speciesTbody.insertRow();
                
                // Image cell
                const imgCell = row.insertCell(0);
                const img = document.createElement('img');
                img.src = `${imagesBasePath}${species.image_name}`;
                img.alt = 'Species image';
                imgCell.appendChild(img);

                // Taxonomic Group cell
                const groupCell = row.insertCell(1);
                groupCell.textContent = species.taxonomic_group || 'N/A';

                // Scientific Name cell
                const sciNameCell = row.insertCell(2);
                sciNameCell.textContent = species.scientific_name || 'N/A';

                // Common Name cell
                const commonNameCell = row.insertCell(3);
                commonNameCell.textContent = species.common_name || 'N/A';

                // Timestamp cell
                const timestampCell = row.insertCell(4);
                timestampCell.textContent = imageTimestamps.get(species.image_name) 
                    ? new Date(imageTimestamps.get(species.image_name)).toLocaleString() 
                    : 'N/A';

                // Add marker to map if location exists
                const matchingHistoryEntry = historyData.find(
                    entry => entry.image_filename === species.image_name
                );

                if (matchingHistoryEntry && matchingHistoryEntry.image_location) {
                    L.marker([
                        matchingHistoryEntry.image_location.latitude, 
                        matchingHistoryEntry.image_location.longitude
                    ])
                     .addTo(map)
                     .bindPopup(`
                        <img src="${imagesBasePath}${species.image_name}" style="max-width:200px;"><br>
                        ${species.common_name || species.scientific_name}
                     `);
                }
            });

            // Fit map to markers
            // const markers = map.getLayers().filter(layer => layer instanceof L.Marker);
            // if (markers.length > 0) {
            //     const group = new L.featureGroup(markers);
            //     map.fitBounds(group.getBounds().pad(0.2));
            // }
        }

        // Filter table function
        function filterTable() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const groupFilter = document.getElementById('groupFilter').value;

            const filtered = speciesData.filter(row => {
                const matchesSearch = Object.values(row).some(value =>
                    value && value.toLowerCase().includes(searchTerm)
                );
                const matchesGroup = !groupFilter || row.taxonomic_group === groupFilter;
                return matchesSearch && matchesGroup;
            });

            // Repopulate table with filtered data
            populateSpeciesTable(
                historyData.filter(entry => 
                    filtered.some(species => species.image_name === entry.image_filename)
                ),
                filtered
            );
        }

        // Load data when page loads
        window.addEventListener('load', loadData);
    </script>
</body>
</html>