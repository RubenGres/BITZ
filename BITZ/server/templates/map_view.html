<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quests Overview</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.css" rel="stylesheet">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }

        .popup-image {
            cursor: pointer;
            transition: opacity 0.2s;
            border: 2px solid transparent;
            width: 100%;
            height: auto;
        }

        .back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            padding: 10px 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            text-decoration: none;
            color: #333;
            font-weight: bold;
        }

        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            max-width: 300px;
            max-height: 30vh;
            overflow-y: auto;
        }

        .info-panel h3 {
            margin-top: 0;
        }

        .species-count {
            font-weight: bold;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <a href="/dashboard/" class="back-button">← Back to Dashboard</a>
    
    <div id="map"></div>
    
    <!-- Control panel removed -->
    
    <div class="info-panel">
        <h3>Overview</h3>
        <div id="total-stats">
            <p>Total Quests: <span class="species-count" id="total-quests">0</span></p>
            <p>Total Species: <span class="species-count" id="total-species">0</span></p>
        </div>
        <div id="selected-quest-info">
            <!-- Selected quest info will be shown here -->
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.js"></script>
    <script>
        // Quest data from backend
        const questsData = {{ quests|tojson }};
        
        // Map initialization
        const map = L.map('map').setView([0, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
        
        // Store markers by quest ID
        const markersByQuest = {};
        
        // Generate a color palette for the quests
        const colorPalette = [
            '#e6194B', '#3cb44b', '#ffe119', '#4363d8', 
            '#f58231', '#911eb4', '#42d4f4', '#f032e6', 
            '#bfef45', '#fabed4', '#469990', '#dcbeff', 
            '#9A6324', '#fffac8', '#800000', '#aaffc3', 
            '#808000', '#ffd8b1', '#000075', '#a9a9a9'
        ];
        
        // Assign colors to quests
        const questColors = {};
        questsData.forEach((quest, index) => {
            questColors[quest.id] = colorPalette[index % colorPalette.length];
        });
        
        // Load data for all quests
        async function loadAllQuestsData() {
            let totalSpeciesCount = 0;
            
            for (const quest of questsData) {
                try {
                    // Fetch history JSON
                    const historyResponse = await fetch(quest.history_path);
                    const historyJson = await historyResponse.json();
                    
                    // Fetch CSV
                    const csvResponse = await fetch(quest.csv_path);
                    const csvText = await csvResponse.text();
                    
                    // Process data
                    const speciesData = processCSV(csvText);
                    totalSpeciesCount += speciesData.length;
                    
                    // Create markers
                    createMarkersForQuest(quest.id, historyJson, speciesData, quest.images_path);
                    
                } catch (error) {
                    console.error(`Error loading data for quest ${quest.id}:`, error);
                }
            }
            
            // Update stats
            document.getElementById('total-quests').textContent = questsData.length;
            document.getElementById('total-species').textContent = totalSpeciesCount;
            
            // Center map to show all markers
            fitMapToAllMarkers();
            
            // Control panel removed
        }
        
        // Process CSV data
        function processCSV(csv) {
            const lines = csv.split('\n');
            const headers = lines[0].split(',');
            
            return lines.slice(1)
                .filter(line => line.trim())
                .map(line => {
                    const values = line.split(',');
                    return {
                        image_name: values[0],
                        taxonomic_group: values[1],
                        scientific_name: values[2],
                        common_name: values[3]
                    };
                });
        }
        
        // Create markers for a quest
        function createMarkersForQuest(questId, historyJson, speciesData, imagesPath) {
            // Initialize array for this quest's markers
            markersByQuest[questId] = [];
            
            // Add center marker for the quest
            if (historyJson.location && historyJson.location.coordinates) {
                const lat = historyJson.location.coordinates.latitude;
                const lng = historyJson.location.coordinates.longitude;
                
                // Create a custom marker with quest color
                const centerIcon = L.divIcon({
                    html: `<div style="background-color: ${questColors[questId]}; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border: 2px solid white; color: white; font-weight: bold;">C</div>`,
                    className: 'center-marker',
                    iconSize: [24, 24],
                    iconAnchor: [12, 12]
                });
                
                const centerMarker = L.marker([lat, lng], { icon: centerIcon }).addTo(map);
                centerMarker.bindPopup(`<strong>Quest ${questId} Center</strong><br>Latitude: ${lat}<br>Longitude: ${lng}`);
                
                // Add to quest markers array
                markersByQuest[questId].push(centerMarker);
            }
            
            // Create a map of image filenames to species info
            const speciesMap = new Map(
                speciesData.map(species => [species.image_name, species])
            );
            
            // Filter history entries with image locations
            const entriesWithLocations = historyJson.history.filter(entry => 
                entry.image_location && 
                entry.image_location.latitude && 
                entry.image_location.longitude &&
                entry.image_filename
            );
            
            // Create markers for each location
            entriesWithLocations.forEach((entry, index) => {
                // Create a custom numbered icon with quest color
                const numberIcon = L.divIcon({
                    html: `<div style="background-color: ${questColors[questId]}; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white;">${index + 1}</div>`,
                    className: 'number-marker',
                    iconSize: [24,, 24],
                    iconAnchor: [12, 12]
                });
                
                // Create the marker
                const marker = L.marker(
                    [entry.image_location.latitude, entry.image_location.longitude],
                    { icon: numberIcon }
                ).addTo(map);
                
                // Prepare popup content
                let popupContent = `<a href="/recap/${questId}"><strong>Quest: ${questId}</strong></a><br>`;
                
                // Add image if available, make it clickable to go to recap page
                if (entry.image_filename) {
                    popupContent += `<img src="${imagesPath}${entry.image_filename}" 
                        class="popup-image" 
                        style="max-width:200px; max-height:150px;"
                        onclick="window.location.href='/recap/${questId}'"
                        title="Click to view detailed quest recap">
                    <br>`;
                }
                
                // Add species info if available
                const speciesInfo = speciesMap.get(entry.image_filename);
                if (speciesInfo) {
                    popupContent += `<strong>${speciesInfo.common_name || 'Unnamed Species'}</strong><br>`;
                    popupContent += `<em>${speciesInfo.scientific_name || 'No scientific name'}</em><br>`;
                    popupContent += `Group: ${speciesInfo.taxonomic_group || 'Unclassified'}<br>`;
                }
                
                // Add timestamp
                popupContent += `<small>Discovered: ${new Date(entry.timestamp).toLocaleString()}</small>`;
                
                // Bind popup to marker
                marker.bindPopup(popupContent);
                
                // Add to quest markers array
                markersByQuest[questId].push(marker);
                
                // Add hover behavior
                marker.on('mouseover', function() {
                    this.openPopup();
                });
            });
        }
        
        // Fit map to show all markers
        function fitMapToAllMarkers() {
            const allMarkers = Object.values(markersByQuest).flat();
            
            if (allMarkers.length > 0) {
                const group = L.featureGroup(allMarkers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }
        
        // Function removed - no more control panel to set up
        
        // Function removed - no more toggle functionality needed
        
        // Load all data when page loads
        window.addEventListener('load', loadAllQuestsData);
    </script>
</body>
</html>